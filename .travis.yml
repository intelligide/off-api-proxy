language: go
go:
  - 1.12.x

stages:
  - compile
  - package
  - deploy

env:
  global:
    - GITHUB_API_KEY:
      - secure: "ZdFHzMt9ljCZkiEgNpnVuRbK+fGjosJw+xn5sQABwoAuYj45srj55BPSGM6yarBHkDYfYvrW/9QpY+p+ul20goCWejD9DvPPNiCMOGEHOrD4xfp/Bg51zNFxDQJKYAjKp1M8qIokJ7oJaKBW065KSUyxkEo0HLsYrndJubGUDbzbXY7vRY3KVCBJQhrKgvgMa0sd+AKlbIknL2S5AjFyw/q0NPJ64Yp5IZ4orjL0DP+Vg0UrWzofalPKbsEsNyqQM8T2kvB9XaKY1aRzJ7+3pgzenTO3Ty0n2hYdmT/XhbcvYN3bMchUX2lMZiJqOD/A05Z3YdUXjjRr5J7tyVqLdq4n5oAmLdap96mrX3Dql1chpBaCRV5d/AT2cd2UbPbYXcZ0dR5k+ZPAqDctuTucbJ7bg6UoMjyznOzmFd80ZMRY6Uli0JHHUBOIJLSdiHvhOgs0XgBzVIP5QE2P3A/W2e+1UKoHyJy9TjXthjdnw1zalAQlgi7L1Kl/C9H/yqBgb92qzFhk8M3M1Z6gIT69YMMA31yaXdVU2Xh/QtV3BCQQ98sqvLnV6MVrUzSsn0uoae/IZRrL+8M3ceQNpSHdhNUWTFuMCmEFqY8ZryDqvaGud/p2jA4GCFOhmZpR1ro1zlzRFgfxLYBfugwCgAbXBQ/JamLHU9Raq6AirT/JyBc="
    - DOCKER_USERNAME: intelligide
    - DOCKER_PASSWORD:
      - secure: "EWwt1GUW05X4Xzic+LN7/CjqW82Mxd/HfMdT1QQKLGVjoSQMMW6TedgVvEFYJwyeEdPvEFsgBOkW9gBCDOj5MsYIJop9JlB9mmQSEehYyz4dQE8H1Hlz5VgEYtBMrHQdiLvetl9gQSG/Yfv4zjUWEx43pz0jy8Iwo49WLCUNttgZbkgv+cvKkCphH2R86mTZsy4GgCt8kj9SBUkCPKCx1/t3tZYEiWgXB9E3uIpGShbd4Wjx5LkLHzr6VbADtPhUZVOUEWWSbs2WJ1gYAnVEV+1KqrGfpzK9gUDb3xjCFkVQBHTqxJ0KGiAbzF0Posbh4iUMFA+KgyMoniuneWTibZH4OT2O39UqslP0vXredE4eF7zrWh6c9oM6tSuxVKMQFbfdii1L1yRjYovOwS84mqcYiNTn18crg4A8kIkIP+iTe/OMVkH6/IjgNIZ9zTKq+4qlMrqhfYQxzTmOSDii/BWG+cLfNtWekJlAS0k6y19OdxnOj4+CSlaBbSM3xLy6vEaNgAONMgASpD+j2KTYi7McbMXRx9DI6HD5xKfhqkDJAAG/0rtdPDtBv2TwVYxPxobII+AL7x8a2eMetjBOmFHJzMtoFo/YCG3Jy7dVlsp1aU3bAz0I7FpTdfYr8byI7yFcfkXoFo12tDC5yei67xvCQjBwKq0/z8ZWH2vlUpM="

####################
# OS Configuration #
####################

linux: &linux
  os: linux
  dist: xenial

osx: &osx
  os: osx

windows: &windows
  os: windows

#######################
# Tasks Configuration #
#######################

compile-task: &compile-task
  script:
    - go mod download
    - go run build.go build all

github-deploy-task: &github-deploy-task
  script: skip
  if: env(TRAVIS_TAG) IS present AND env(TRAVIS_TAG) IS NOT blank
  deploy:
    provider: releases
    api_key: ${GITHUB_API_KEY}
    skip_cleanup: true
    file:
      - build/bin/off-proxy
    on:
      repo: intelligide/off-api-proxy
      tags: true

########
# Jobs #
########

jobs:
  include:
    - stage: compile
      name: "Compile on Linux"
      <<: *linux
      <<: *compile-task

    - name: "Compile on macOS"
      <<: *osx
      <<: *compile-task

    - name: "Compile on Windows"
      <<: *windows
      <<: *compile-task

    - stage: package
      name: "Build Docker image"
      services:
        - docker
      script:
        - echo "$DOCKER_PASSWORD" | docker login registry.gitlab.com -u "$DOCKER_USERNAME" --password-stdin
        - docker build -t registry.gitlab.com/$DOCKER_USERNAME/off-proxy:dev .
        - docker push registry.gitlab.com/$DOCKER_USERNAME/off-proxy:dev

    - stage: deploy
      <<: *linux
      <<: *github-deploy-task

    - <<: *osx
      <<: *github-deploy-task

    - <<: *windows
      <<: *github-deploy-task

install:
  - mkdir -p $HOME/src
  - mv $TRAVIS_BUILD_DIR $HOME/src
  - export TRAVIS_BUILD_DIR=$HOME/src/off-api-proxy
  - cd $HOME/src/off-api-proxy


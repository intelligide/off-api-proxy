language: go
go:
  - 1.12.x

stages:
  - compile
  - package

####################
# OS Configuration #
####################

linux: &linux
  os: linux
  dist: xenial

osx: &osx
  os: osx

windows: &windows
  os: windows

#######################
# Tasks Configuration #
#######################

compile-task: &compile-task
  script:
    - go mod download
    - go run build.go build all

########
# Jobs #
########

jobs:
  include:
    - stage: compile
      <<: *compile-task
      <<: *linux

    - <<: *osx
      <<: *compile-task


    - <<: *windows
      <<: *compile-task

    - stage: package
      name: "Build Docker image"
      services:
        - docker
      script:
#        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker build -t off-proxy ./package/docker
        - docker images
#        - docker tag travis-ci-build-stages-demo $DOCKER_USERNAME/travis-ci-build-stages-demo
#        - docker push $DOCKER_USERNAME/travis-ci-build-stages-demo

install:
  - mkdir -p $HOME/src
  - mv $TRAVIS_BUILD_DIR $HOME/src
  - export TRAVIS_BUILD_DIR=$HOME/src/off-api-proxy
  - cd $HOME/src/off-api-proxy

